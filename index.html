<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Flotta 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --primary:#2563eb;
  --shadow:0 10px 30px rgba(0,0,0,0.06);
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:1200px;
  margin:60px auto;
  padding:0 40px;
}

h1{
  font-size:28px;
  font-weight:600;
  margin-bottom:40px;
}

.filters{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:var(--shadow);
  display:flex;
  flex-wrap:wrap;
  gap:30px;
  align-items:flex-end;
}

.filters label{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.05em;
  color:var(--muted);
}

select{
  min-width:170px;
  padding:6px;
  border-radius:8px;
  border:1px solid #e5e7eb;
}

button{
  padding:10px 18px;
  border-radius:10px;
  border:none;
  background:var(--primary);
  color:white;
  cursor:pointer;
}

.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:24px;
  margin:40px 0;
}

.card{
  background:var(--card);
  padding:24px;
  border-radius:18px;
  box-shadow:var(--shadow);
}

.card-title{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.05em;
  color:var(--muted);
}

.card-value{
  font-size:30px;
  font-weight:600;
  margin-top:8px;
}

.chart-wrapper{
  background:var(--card);
  padding:40px;
  border-radius:22px;
  box-shadow:var(--shadow);
  margin-top:20px;
}

.chart-container{
  max-width:850px;
  margin:auto;
}

canvas{
  height:340px !important;
}

.table-wrapper{
  background:var(--card);
  margin-top:60px;
  padding:40px;
  border-radius:22px;
  box-shadow:var(--shadow);
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:14px;
  font-size:14px;
  text-align:left;
}

th{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.05em;
  color:var(--muted);
}

tr:not(:last-child){
  border-bottom:1px solid #f0f2f5;
}
</style>
</head>

<body>
<div class="container">

<h1>Dashboard Flotta 2026</h1>

<div class="filters">
  <div>
    <label>Mesi</label><br>
    <select id="monthFilter" multiple size="4"></select>
  </div>
  <div>
    <label>Carline</label><br>
    <select id="carlineFilter" multiple size="4"></select>
  </div>
  <div>
    <label>Provider</label><br>
    <select id="providerFilter" multiple size="4"></select>
  </div>
  <div>
    <label>Macro Gruppo</label><br>
    <select id="macroFilter" multiple size="4"></select>
  </div>
  <div>
    <button onclick="resetFilters()">Reset Filtri</button>
  </div>
</div>

<div class="kpi-grid">
  <div class="card">
    <div class="card-title" id="fleetTitle">Flotta Media 2026</div>
    <div class="card-value" id="totalFleet">0</div>
  </div>
  <div class="card">
    <div class="card-title">Provider Attivi</div>
    <div class="card-value" id="totalProviders">0</div>
  </div>
  <div class="card">
    <div class="card-title">Carline Attive</div>
    <div class="card-value" id="totalCarline">0</div>
  </div>
  <div class="card">
    <div class="card-title">% Premium Fleet</div>
    <div class="card-value" id="premiumShare">0%</div>
  </div>
</div>

<div class="chart-wrapper">
  <div class="chart-container">
    <canvas id="fleetChart"></canvas>
  </div>
</div>

<div class="table-wrapper">
  <h3>Distribuzione Carline</h3>
  <table>
    <thead>
      <tr>
        <th>Carline</th>
        <th>Totale</th>
        <th>Macro Gruppo</th>
      </tr>
    </thead>
    <tbody id="carlineTable"></tbody>
  </table>
</div>

</div>

<script>

let fleetData=[];
let chart;

const months2026=["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];

const macroMap={
  "group a":"Mini",
  "group b":"Small",
  "group c":"Economy",
  "group d":"Large",
  "group e":"Premium",
  "group f":"Premium",
  "group j":"SUV",
  "group m":"Commercial Van"
};

fetch('fleet.json')
.then(res=>res.json())
.then(data=>{
  fleetData=data;
  initFilters();
  updateDashboard();
});

function parseDate(dateString){
  if(!dateString) return null;
  const [y,m,d]=dateString.split("-").map(Number);
  return new Date(y,m-1,d);
}

function getMacroGroup(carline){
  if(!carline) return "Economy";
  const name=carline.toLowerCase();

  const premiumBrands=["audi","bmw","mercedes","volvo","lexus","tesla","porsche","jaguar","land rover","alfa","ds"];
  if(premiumBrands.some(b=>name.includes(b))) return "Premium";

  for(const key in macroMap){
    if(name.includes(key)) return macroMap[key];
  }

  if(name.includes("suv")) return "SUV";
  if(name.includes("sw")) return "Station Wagon";
  if(name.includes("cabrio")) return "Cabriolet";
  if(name.includes("9 seats")||name.includes("9 posti")) return "People Mover";
  if(name.includes("van")) return "Commercial Van";

  return "Economy";
}

function initFilters(){
  months2026.forEach((m,i)=>monthFilter.innerHTML+=`<option value="${i}">${m}</option>`);
  [...new Set(fleetData.map(f=>f.carline))].forEach(c=>carlineFilter.innerHTML+=`<option value="${c}">${c}</option>`);
  [...new Set(fleetData.map(f=>f.provider))].forEach(p=>providerFilter.innerHTML+=`<option value="${p}">${p}</option>`);

  const macros=["Mini","Small","Economy","Large","SUV","Premium","Station Wagon","Cabriolet","People Mover","Commercial Van"];
  macros.forEach(m=>macroFilter.innerHTML+=`<option value="${m}">${m}</option>`);

  document.querySelectorAll("select").forEach(s=>s.addEventListener("change",updateDashboard));
}

function getSelectedValues(id){
  return [...document.getElementById(id).selectedOptions].map(o=>o.value);
}

function resetFilters(){
  document.querySelectorAll("select").forEach(s=>[...s.options].forEach(o=>o.selected=false));
  updateDashboard();
}

function isActiveInMonth(vehicle,monthIndex){
  const start=parseDate(vehicle.date_in);
  const end=vehicle.date_out?parseDate(vehicle.date_out):new Date(2026,11,31);

  const monthStart=new Date(2026,monthIndex,1);
  const monthEnd=new Date(2026,monthIndex+1,0);

  return start<=monthEnd && end>=monthStart;
}

function updateDashboard(){

  const selectedMonths=getSelectedValues("monthFilter").map(Number);
  const selectedCarline=getSelectedValues("carlineFilter");
  const selectedProvider=getSelectedValues("providerFilter");
  const selectedMacro=getSelectedValues("macroFilter");

  const yearStart=new Date(2026,0,1);
  const yearEnd=new Date(2026,11,31);

  let enriched=fleetData
    .map(f=>({...f,macro:getMacroGroup(f.carline)}))
    .filter(f=>{
      if(!f.date_in) return false;
      const start=parseDate(f.date_in);
      const end=f.date_out?parseDate(f.date_out):yearEnd;
      return start<=yearEnd && end>=yearStart;
    });

  let filtered=enriched.filter(f=>{
    return (selectedCarline.length===0||selectedCarline.includes(f.carline))
      && (selectedProvider.length===0||selectedProvider.includes(f.provider))
      && (selectedMacro.length===0||selectedMacro.includes(f.macro));
  });

  let monthlyCounts=months2026.map((_,i)=>filtered.filter(f=>isActiveInMonth(f,i)).length);

  let labels=months2026;
  let dataPoints=monthlyCounts;

  if(selectedMonths.length>0){
    labels=selectedMonths.map(i=>months2026[i]);
    dataPoints=selectedMonths.map(i=>monthlyCounts[i]);
  }

  const noFilters=selectedMonths.length===0 && selectedCarline.length===0 && selectedProvider.length===0 && selectedMacro.length===0;

  const yearlyAverage=(monthlyCounts.reduce((a,b)=>a+b,0)/12).toFixed(1);

  if(noFilters){
    totalFleet.innerText=yearlyAverage;
    fleetTitle.innerText="Flotta Media 2026";
  }else{
    totalFleet.innerText=filtered.length;
    fleetTitle.innerText="Flotta Filtrata";
  }

  totalProviders.innerText=new Set(filtered.map(f=>f.provider)).size;
  totalCarline.innerText=new Set(filtered.map(f=>f.carline)).size;

  const premiumCount=filtered.filter(f=>f.macro==="Premium").length;
  premiumShare.innerText=filtered.length>0?((premiumCount/filtered.length)*100).toFixed(1)+"%":"0%";

  if(chart) chart.destroy();

  chart=new Chart(fleetChart,{
    type:'line',
    data:{
      labels:labels,
      datasets:[{
        data:dataPoints,
        borderColor:"#2563eb",
        backgroundColor:"rgba(37,99,235,0.15)",
        borderWidth:3,
        tension:.35,
        fill:true
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true}}
    }
  });

  const counts={};
  filtered.forEach(f=>counts[f.carline]=(counts[f.carline]||0)+1);

  carlineTable.innerHTML="";
  Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .forEach(([carline,count])=>{
      carlineTable.innerHTML+=`
      <tr>
        <td>${carline}</td>
        <td>${count}</td>
        <td>${getMacroGroup(carline)}</td>
      </tr>`;
  });
}

</script>
</body>
</html>
