<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Flotta 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: 'Segoe UI', Arial;
  margin: 40px;
  background:#f4f6f9;
}

h1 { margin-bottom:30px; }

.filters {
  background:white;
  padding:20px;
  border-radius:14px;
  box-shadow:0 3px 12px rgba(0,0,0,0.06);
  display:flex;
  gap:25px;
  flex-wrap:wrap;
  align-items:flex-end;
}

select {
  min-width:170px;
  padding:6px;
}

button {
  padding:9px 16px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:white;
  cursor:pointer;
  font-weight:500;
}

button:hover { opacity:0.9; }

.kpi-container {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:20px;
  margin:30px 0;
}

.card {
  background:white;
  padding:22px;
  border-radius:14px;
  box-shadow:0 3px 12px rgba(0,0,0,0.05);
}

.card-title {
  font-size:13px;
  color:#6b7280;
}

.card-value {
  font-size:30px;
  font-weight:600;
  margin-top:8px;
}

canvas {
  background:white;
  padding:20px;
  border-radius:14px;
  box-shadow:0 3px 12px rgba(0,0,0,0.05);
}

table {
  margin-top:40px;
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 3px 12px rgba(0,0,0,0.05);
}

th, td {
  padding:11px;
  text-align:center;
}

th {
  background:#eef2f7;
}

tr:nth-child(even) { background:#f9fafc; }

</style>
</head>

<body>

<h1>Dashboard Flotta 2026</h1>

<div class="filters">

  <div>
    <label>Mesi</label><br>
    <select id="monthFilter" multiple size="4"></select>
  </div>

  <div>
    <label>Carline</label><br>
    <select id="carlineFilter" multiple size="4"></select>
  </div>

  <div>
    <label>Provider</label><br>
    <select id="providerFilter" multiple size="4"></select>
  </div>

  <div>
    <label>Macro Gruppo</label><br>
    <select id="macroFilter" multiple size="4"></select>
  </div>

  <div>
    <button onclick="resetFilters()">Reset Filtri</button>
  </div>

</div>

<div class="kpi-container">
  <div class="card">
    <div class="card-title">Flotta Totale</div>
    <div class="card-value" id="totalFleet">0</div>
  </div>

  <div class="card">
    <div class="card-title">Provider Attivi</div>
    <div class="card-value" id="totalProviders">0</div>
  </div>

  <div class="card">
    <div class="card-title">Carline Attive</div>
    <div class="card-value" id="totalCarline">0</div>
  </div>

  <div class="card">
    <div class="card-title">Flotta Media Mensile</div>
    <div class="card-value" id="avgFleet">0</div>
  </div>

  <div class="card">
    <div class="card-title">% Premium Fleet</div>
    <div class="card-value" id="premiumShare">0%</div>
  </div>
</div>

<canvas id="fleetChart"></canvas>

<h2>Distribuzione Carline</h2>
<table>
<thead>
<tr>
<th>Carline</th>
<th>Totale Veicoli</th>
<th>Macro Gruppo</th>
</tr>
</thead>
<tbody id="carlineTable"></tbody>
</table>

<script>

let fleetData = [];
let chart;

const months2026 = [
  "Gen","Feb","Mar","Apr","Mag","Giu",
  "Lug","Ago","Set","Ott","Nov","Dic"
];

fetch('fleet.json')
.then(res=>res.json())
.then(data=>{
  fleetData=data;
  initFilters();
  updateDashboard();
});

function getMacroGroup(carline){

  const name = carline ? carline.toLowerCase() : "";

  const premiumBrands = [
    "audi","bmw","mercedes","volvo","lexus",
    "tesla","porsche","jaguar","land rover",
    "alfa","ds"
  ];

  if(premiumBrands.some(b=>name.includes(b)))
    return "Premium";

  if(name.includes("van") || name.includes("transit") || name.includes("doblo"))
    return "Commercial Van";

  if(name.includes("9 posti") || name.includes("people"))
    return "People Mover";

  if(name.includes("cabrio"))
    return "Cabriolet";

  if(name.includes("sw") || name.includes("station"))
    return "Station Wagon";

  if(name.includes("suv") || name.includes("x") || name.includes("qashqai") || name.includes("tucson"))
    return "SUV";

  if(name.includes("passat") || name.includes("superb"))
    return "Large";

  if(name.includes("clio") || name.includes("208") || name.includes("polo"))
    return "Small";

  if(name.includes("panda") || name.includes("500") || name.includes("mini"))
    return "Mini";

  return "Economy";
}

function initFilters(){

  months2026.forEach((m,i)=>{
    document.getElementById("monthFilter")
      .innerHTML+=`<option value="${i}">${m}</option>`;
  });

  [...new Set(fleetData.map(f=>f.carline))]
    .forEach(c=>{
      document.getElementById("carlineFilter")
        .innerHTML+=`<option value="${c}">${c}</option>`;
  });

  [...new Set(fleetData.map(f=>f.provider))]
    .forEach(p=>{
      document.getElementById("providerFilter")
        .innerHTML+=`<option value="${p}">${p}</option>`;
  });

  const macros=[
    "Mini","Small","Economy","Large",
    "SUV","Premium","Station Wagon",
    "Cabriolet","People Mover","Commercial Van"
  ];

  macros.forEach(m=>{
    document.getElementById("macroFilter")
      .innerHTML+=`<option value="${m}">${m}</option>`;
  });

  document.querySelectorAll("select")
    .forEach(s=>s.addEventListener("change", updateDashboard));
}

function getSelectedValues(id){
  return [...document.getElementById(id).selectedOptions]
    .map(o=>o.value);
}

function resetFilters(){
  document.querySelectorAll("select")
    .forEach(s=>[...s.options].forEach(o=>o.selected=false));
  updateDashboard();
}

function isActiveInMonth(vehicle, monthIndex){

  if(!vehicle.date_in) return false;

  const start=new Date(vehicle.date_in);
  const end=vehicle.date_out
    ? new Date(vehicle.date_out)
    : new Date("2026-12-31");

  const monthStart=new Date(2026,monthIndex,1);
  const monthEnd=new Date(2026,monthIndex+1,0);

  return start<=monthEnd && end>=monthStart;
}

function updateDashboard(){

  const selectedMonths=getSelectedValues("monthFilter").map(Number);
  const selectedCarline=getSelectedValues("carlineFilter");
  const selectedProvider=getSelectedValues("providerFilter");
  const selectedMacro=getSelectedValues("macroFilter");

  let filtered=fleetData
    .map(f=>({...f, macro:getMacroGroup(f.carline)}))
    .filter(f=>{
      return (selectedCarline.length===0 || selectedCarline.includes(f.carline))
        && (selectedProvider.length===0 || selectedProvider.includes(f.provider))
        && (selectedMacro.length===0 || selectedMacro.includes(f.macro));
    });

  document.getElementById("totalFleet").innerText=filtered.length;
  document.getElementById("totalProviders").innerText=
    new Set(filtered.map(f=>f.provider)).size;
  document.getElementById("totalCarline").innerText=
    new Set(filtered.map(f=>f.carline)).size;

  let monthlyCounts=months2026.map((_,i)=>
    filtered.filter(f=>isActiveInMonth(f,i)).length
  );

  let avg=(monthlyCounts.reduce((a,b)=>a+b,0)/12).toFixed(1);
  document.getElementById("avgFleet").innerText=avg;

  let premiumCount=filtered.filter(f=>f.macro==="Premium").length;
  let premiumShare=filtered.length>0
    ? ((premiumCount/filtered.length)*100).toFixed(1)
    : 0;

  document.getElementById("premiumShare").innerText=premiumShare+"%";

  if(chart) chart.destroy();

  chart=new Chart(document.getElementById("fleetChart"),{
    type:'line',
    data:{
      labels:months2026,
      datasets:[{
        label:'Flotta Attiva 2026',
        data:monthlyCounts,
        borderWidth:3,
        tension:0.3,
        fill:true
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:false }},
      scales:{ y:{ beginAtZero:true }}
    }
  });

  const counts={};
  filtered.forEach(f=>{
    counts[f.carline]=(counts[f.carline]||0)+1;
  });

  const tbody=document.getElementById("carlineTable");
  tbody.innerHTML="";

  Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .forEach(([carline,count])=>{
      const macro=getMacroGroup(carline);
      tbody.innerHTML+=`
      <tr>
        <td>${carline}</td>
        <td>${count}</td>
        <td>${macro}</td>
      </tr>`;
  });
}

</script>

</body>
</html>
