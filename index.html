<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Flotta 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: 'Segoe UI', Arial;
  margin: 40px;
  background:#f5f7fa;
}

h1 { margin-bottom:30px; }

.filters {
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  align-items:flex-end;
}

select {
  min-width:160px;
  padding:6px;
}

button {
  padding:8px 14px;
  border:none;
  border-radius:6px;
  background:#2c7be5;
  color:white;
  cursor:pointer;
}

button:hover { opacity:0.9; }

.kpi-container {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:20px;
  margin:30px 0;
}

.card {
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
}

.card-title {
  font-size:14px;
  color:#6c757d;
}

.card-value {
  font-size:28px;
  font-weight:bold;
  margin-top:8px;
}

canvas {
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
}

table {
  margin-top:40px;
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:12px;
  overflow:hidden;
}

th, td {
  padding:10px;
  text-align:center;
}

th {
  background:#f1f3f5;
}

tr:nth-child(even) { background:#f9fbfd; }

</style>
</head>

<body>

<h1>Dashboard Flotta 2026</h1>

<div class="filters">
  <div>
    <label>Mesi</label><br>
    <select id="monthFilter" multiple size="4"></select>
  </div>

  <div>
    <label>Carline</label><br>
    <select id="carlineFilter" multiple size="4"></select>
  </div>

  <div>
    <label>Provider</label><br>
    <select id="providerFilter" multiple size="4"></select>
  </div>

  <div>
    <button onclick="resetFilters()">Reset Filtri</button>
  </div>
</div>

<div class="kpi-container">
  <div class="card">
    <div class="card-title">Flotta Totale</div>
    <div class="card-value" id="totalFleet">0</div>
  </div>

  <div class="card">
    <div class="card-title">Provider Attivi</div>
    <div class="card-value" id="totalProviders">0</div>
  </div>

  <div class="card">
    <div class="card-title">Carline Attive</div>
    <div class="card-value" id="totalCarline">0</div>
  </div>

  <div class="card">
    <div class="card-title">Flotta Media Mensile</div>
    <div class="card-value" id="avgFleet">0</div>
  </div>
</div>

<canvas id="fleetChart"></canvas>

<h2>Dettaglio Carline</h2>
<table>
<thead>
<tr>
<th>Carline</th>
<th>Totale Veicoli</th>
</tr>
</thead>
<tbody id="carlineTable"></tbody>
</table>

<script>

let fleetData = [];
let chart;

const months2026 = [
  "Gen","Feb","Mar","Apr","Mag","Giu",
  "Lug","Ago","Set","Ott","Nov","Dic"
];

fetch('fleet.json')
.then(res=>res.json())
.then(data=>{
  fleetData=data;
  initFilters();
  updateDashboard();
});

function initFilters(){

  const monthSel=document.getElementById("monthFilter");
  months2026.forEach((m,i)=>{
    monthSel.innerHTML+=`<option value="${i}">${m}</option>`;
  });

  const carlines=[...new Set(fleetData.map(f=>f.carline))];
  const providers=[...new Set(fleetData.map(f=>f.provider))];

  carlines.forEach(c=>{
    document.getElementById("carlineFilter")
      .innerHTML+=`<option value="${c}">${c}</option>`;
  });

  providers.forEach(p=>{
    document.getElementById("providerFilter")
      .innerHTML+=`<option value="${p}">${p}</option>`;
  });

  document.querySelectorAll("select")
    .forEach(s=>s.addEventListener("change", updateDashboard));
}

function getSelectedValues(id){
  return [...document.getElementById(id).selectedOptions]
         .map(o=>o.value);
}

function resetFilters(){
  document.querySelectorAll("select").forEach(s=>{
    [...s.options].forEach(o=>o.selected=false);
  });
  updateDashboard();
}

function isActiveInMonth(vehicle, monthIndex){
  const start=new Date(vehicle.date_in);
  const end=vehicle.date_out
    ? new Date(vehicle.date_out)
    : new Date("2026-12-31");

  const monthStart=new Date(2026,monthIndex,1);
  const monthEnd=new Date(2026,monthIndex+1,0);

  return start<=monthEnd && end>=monthStart;
}
function getMacroGroup(carline) {

  const name = carline.toLowerCase();

  // ðŸ”¹ PREMIUM (prioritÃ  alta)
  const premiumBrands = [
    "audi","bmw","mercedes","volvo","lexus",
    "tesla","porsche","jaguar","land rover",
    "alfa","ds"
  ];

  if (premiumBrands.some(b => name.includes(b)))
    return "Premium";

  // ðŸ”¹ COMMERCIAL
  if (name.includes("van") || name.includes("transit") || name.includes("doblo"))
    return "Commercial Van";

  // ðŸ”¹ PEOPLE MOVER
  if (name.includes("9 posti") || name.includes("people"))
    return "People Mover";

  // ðŸ”¹ CABRIO
  if (name.includes("cabrio"))
    return "Cabriolet";

  // ðŸ”¹ STATION WAGON
  if (name.includes("sw") || name.includes("station"))
    return "Station Wagon";

  // ðŸ”¹ SUV
  if (name.includes("suv") || name.includes("x") || name.includes("qashqai") || name.includes("tucson"))
    return "SUV";

  // ðŸ”¹ LARGE
  if (name.includes("passat") || name.includes("superb") || name.includes("large"))
    return "Large";

  // ðŸ”¹ ECONOMY
  if (name.includes("economy"))
    return "Economy";

  // ðŸ”¹ SMALL
  if (name.includes("clio") || name.includes("208") || name.includes("polo"))
    return "Small";

  // ðŸ”¹ MINI
  if (name.includes("panda") || name.includes("500") || name.includes("mini"))
    return "Mini";

  return "Economy"; // fallback
}
function updateDashboard(){

  const selectedMonths=getSelectedValues("monthFilter").map(Number);
  const selectedCarline=getSelectedValues("carlineFilter");
  const selectedProvider=getSelectedValues("providerFilter");

  let filtered=fleetData.filter(f=>{
    return (selectedCarline.length===0 || selectedCarline.includes(f.carline))
      && (selectedProvider.length===0 || selectedProvider.includes(f.provider));
  });

  document.getElementById("totalFleet").innerText=filtered.length;
  document.getElementById("totalProviders").innerText=
    new Set(filtered.map(f=>f.provider)).size;
  document.getElementById("totalCarline").innerText=
    new Set(filtered.map(f=>f.carline)).size;

  let monthlyCounts=months2026.map((_,i)=>{
    return filtered.filter(f=>isActiveInMonth(f,i)).length;
  });

  let filteredMonthly=selectedMonths.length>0
    ? monthlyCounts.filter((_,i)=>selectedMonths.includes(i))
    : monthlyCounts;

  let labels=selectedMonths.length>0
    ? selectedMonths.map(i=>months2026[i])
    : months2026;

  let avg = (monthlyCounts.reduce((a,b)=>a+b,0)/12).toFixed(1);
  document.getElementById("avgFleet").innerText=avg;

  if(chart) chart.destroy();

  chart=new Chart(document.getElementById("fleetChart"),{
    type:'line',
    data:{
      labels:labels,
      datasets:[{
        label:'Flotta Attiva 2026',
        data:filteredMonthly,
        borderWidth:3,
        tension:0.3,
        fill:true
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{ display:false }
      },
      scales:{
        y:{ beginAtZero:true }
      }
    }
  });

  const counts={};
  filtered.forEach(f=>{
    counts[f.carline]=(counts[f.carline]||0)+1;
  });

  const tbody=document.getElementById("carlineTable");
  tbody.innerHTML="";

  Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .forEach(([carline,count])=>{
      tbody.innerHTML+=`
      <tr>
        <td>${carline}</td>
        <td>${count}</td>
      </tr>`;
  });
}

</script>

</body>
</html>
